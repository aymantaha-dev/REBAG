services:
  # الخدمة الخلفية (Node.js)
  - type: web
    name: rebag-backend
    env: node
    plan: free
    buildCommand: cd backend && npm ci
    startCommand: cd backend && node server.js
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: ML_SERVICE_URL
        value: http://rebag-ml-service:5050
      - key: MAX_IMAGE_SIZE
        value: 10485760
      - key: MAX_VIDEO_SIZE
        value: 52428800
      - key: UPLOAD_DIR
        value: /tmp/uploads  # ✅ استخدام مجلد مؤقت للنظام

  # خدمة الذكاء الاصطناعي (Python)
  - type: web
    name: rebag-ml-service
    env: python
    plan: free
    buildCommand: |
      cd ml &&
      pip install -r requirements.txt &&
      wget -q -O model/u2net.onnx https://github.com/danielgatis/rembg/releases/download/v0.0.0/u2net.onnx
    startCommand: cd ml && python bg_removal_service.py
    healthCheckPath: /health
    envVars:
      - key: ML_SERVICE_PORT
        value: 5050
      - key: MODEL_DIR
        value: ./model
      - key: U2NET_HOME
        value: ./model

  # خدمة Redis للطابور (تدعم الخطط المجانية)
  - type: redis
    name: rebag-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: [] # لا تسمح بالوصول من عناوين IP خارجية
