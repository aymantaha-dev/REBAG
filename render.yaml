services:
  - type: web
    name: rebag-backend
    env: node
    region: oregon
    plan: free
    buildCommand: cd backend && npm install
    startCommand: cd backend && node server.js
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: ML_SERVICE_URL
        value: http://rebag-ml-service:5050
      - key: REDIS_URL
        value: redis://rebag-redis:6379
      - key: PORT
        value: 3000
      - key: MAX_IMAGE_SIZE
        value: 10485760
      - key: MAX_VIDEO_SIZE
        value: 52428800

  - type: web
    name: rebag-ml-service
    env: python
    region: oregon
    plan: free
    buildCommand: cd ml && pip install -r requirements.txt && sh model/download-model.sh
    startCommand: cd ml && python bg_removal_service.py
    healthCheckPath: /health
    envVars:
      - key: ML_SERVICE_PORT
        value: 5050
      - key: MODEL_DIR
        value: ./model
      - key: U2NET_HOME
        value: ./model

  - type: redis
    name: rebag-redis
    region: oregon
    plan: free
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru

 jobs:
  - type: cron
    name: cleanup-old-files
    schedule: "0 3 * * *"
    command: cd backend && node scripts/cleanup.js
    service: rebag-backend

